<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NO Support Tool â€” Network Diagnostics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Twemoji for cross-platform flag emoji support -->
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <style>
        /* Twemoji flag sizing */
        img.emoji {
            height: 1em;
            width: 1em;
            margin: 0 .05em 0 .1em;
            vertical-align: -0.1em;
        }

        .leaderboard-flag img.emoji,
        .country-flag img.emoji {
            height: 1.2em;
            width: 1.2em;
        }

        .country-flag img.emoji {
            height: 1.75em;
            width: 1.75em;
        }
        :root {
            /* Base palette - observatory/instrumentation */
            --bg-primary: #0a0c0f;
            --bg-secondary: #12151a;
            --bg-tertiary: #1a1e25;
            --bg-elevated: #222830;

            /* Text hierarchy */
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-tertiary: #5f6368;
            --text-muted: #3c4043;

            /* Signal colors - intentionally muted/observational */
            --signal-pass: #4a9f7e;
            --signal-pass-bg: rgba(74, 159, 126, 0.12);
            --signal-warn: #c9a227;
            --signal-warn-bg: rgba(201, 162, 39, 0.12);
            --signal-fail: #b86a5c;
            --signal-fail-bg: rgba(184, 106, 92, 0.12);

            /* Accent - cool teal for interactive/highlight */
            --accent: #5c9aa8;
            --accent-dim: rgba(92, 154, 168, 0.15);

            /* Borders */
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-default: rgba(255, 255, 255, 0.1);
            --border-strong: rgba(255, 255, 255, 0.15);

            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;

            /* Spacing scale */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;

            /* Grid */
            --grid-gap: 20px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Subtle scan line effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* Layout */
        .dashboard {
            max-width: 1440px;
            margin: 0 auto;
            padding: var(--space-xl);
        }

        /* Header */
        .header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-2xl);
            padding-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-main {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 11px;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 500;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .header-title .subtitle {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            font-weight: 400;
            margin-top: 2px;
        }

        /* Domain nav */
        .domain-nav {
            display: flex;
            gap: var(--space-xs);
        }

        .domain-tab {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .domain-tab:hover {
            border-color: var(--border-default);
            color: var(--text-secondary);
        }

        .domain-tab.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        .domain-tab.future {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Section structure */
        .section {
            margin-bottom: var(--space-2xl);
        }

        .section-header {
            margin-bottom: var(--space-lg);
        }

        .section-question {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            margin-bottom: var(--space-xs);
            opacity: 0.8;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        /* Metric cards grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--grid-gap);
        }

        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: var(--space-lg);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent) 0%, transparent 100%);
            opacity: 0.5;
        }

        .metric-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .metric-value {
            font-family: var(--font-mono);
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            line-height: 1;
        }

        .metric-unit {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: var(--space-xs);
        }

        /* Inline notes */
        .inline-note {
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-left: 2px solid var(--border-default);
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .inline-note.error {
            border-left-color: var(--signal-fail);
            color: var(--signal-fail);
        }

        /* Notable observations section */
        .observations-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .observation-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--signal-warn);
            border-radius: 0 8px 8px 0;
            padding: var(--space-md) var(--space-lg);
            display: flex;
            align-items: flex-start;
            gap: var(--space-lg);
        }

        .observation-card.severity-fail {
            border-left-color: var(--signal-fail);
        }

        .observation-card.severity-warn {
            border-left-color: var(--signal-warn);
        }

        .observation-flag {
            font-size: 1.5rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .observation-content {
            flex: 1;
            min-width: 0;
        }

        .observation-headline {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .observation-detail {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .observation-meta {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-sm);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .observation-empty {
            color: var(--text-tertiary);
            font-size: 0.85rem;
            padding: var(--space-lg);
            text-align: center;
        }

        .observation-provenance {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-tertiary);
            text-align: right;
            margin-top: var(--space-sm);
            font-style: italic;
        }

        /* Operations table */
        .operations-table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            overflow: hidden;
        }

        .operations-table {
            width: 100%;
            border-collapse: collapse;
        }

        .operations-table th {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-tertiary);
            text-align: left;
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 500;
        }

        .operations-table th:not(:first-child) {
            text-align: center;
        }

        .operations-table td {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.85rem;
        }

        .operations-table td:not(:first-child) {
            text-align: center;
            font-family: var(--font-mono);
        }

        .operations-table tr:last-child td {
            border-bottom: none;
        }

        .operations-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .operation-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .signal-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            padding: var(--space-xs) var(--space-sm);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .signal-count.pass {
            background: var(--signal-pass-bg);
            color: var(--signal-pass);
        }

        .signal-count.warn {
            background: var(--signal-warn-bg);
            color: var(--signal-warn);
        }

        .signal-count.fail {
            background: var(--signal-fail-bg);
            color: var(--signal-fail);
        }

        .signal-rate {
            color: var(--text-secondary);
        }

        .signal-rate-bar {
            display: inline-block;
            width: 60px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-right: var(--space-sm);
            overflow: hidden;
            vertical-align: middle;
        }

        .signal-rate-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Countries grid */
        .countries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--grid-gap);
        }

        .country-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: var(--space-lg);
            transition: border-color 0.2s ease;
        }

        .country-card:hover {
            border-color: var(--border-default);
        }

        .country-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-subtle);
        }

        .country-flag {
            font-size: 1.75rem;
            line-height: 1;
        }

        .country-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .country-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }

        .country-metric {
            padding: var(--space-sm) 0;
        }

        .country-metric-label {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: var(--space-xs);
        }

        .country-metric-value {
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .country-metric.full-width {
            grid-column: span 2;
            padding-top: var(--space-md);
            margin-top: var(--space-sm);
            border-top: 1px solid var(--border-subtle);
        }

        .top-operation {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .top-operation-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--signal-warn);
        }

        /* Footer */
        .dashboard-footer {
            margin-top: var(--space-2xl);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-subtle);
            text-align: center;
        }

        .footer-note {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Loading state */
        .loading {
            color: var(--text-tertiary);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: var(--space-md);
            }

            .header {
                flex-direction: column;
                gap: var(--space-lg);
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .domain-nav {
                flex-wrap: wrap;
            }
        }

        /* Loading animation for initial render */
        .section {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.4s ease forwards;
        }

        .section:nth-child(1) { animation-delay: 0.1s; }
        .section:nth-child(2) { animation-delay: 0.2s; }
        .section:nth-child(3) { animation-delay: 0.3s; }
        .section:nth-child(4) { animation-delay: 0.4s; }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-main">
                <div class="logo">NO</div>
                <div class="header-title">
                    <h1>NO Support Tool</h1>
                    <div class="subtitle">Diagnostic Observatory</div>
                </div>
            </div>
            <nav class="domain-nav">
                <button class="domain-tab active">Network</button>
                <button class="domain-tab future" title="Coming soon">System</button>
                <button class="domain-tab future" title="Coming soon">Permissions</button>
                <button class="domain-tab future" title="Coming soon">Environment</button>
                <button class="domain-tab future" title="Coming soon">Hardware</button>
            </nav>
        </header>

        <!-- Error Banner (hidden by default) -->
        <div id="error-banner" class="inline-note error" style="display: none; margin-bottom: var(--space-lg);"></div>

        <!-- Network Overview -->
        <section class="section">
            <div class="section-header">
                <div class="section-question">Question Answered</div>
                <h2 class="section-title">How much network diagnostic data do we have, and how noisy is it overall?</h2>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Diagnostics Runs</div>
                    <div class="metric-value" id="metric-runs"><span class="loading">â€”</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Countries Observed</div>
                    <div class="metric-value" id="metric-countries"><span class="loading">â€”</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Runs with Signals</div>
                    <div class="metric-value" id="metric-signals"><span class="loading">â€”</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Signal Density</div>
                    <div class="metric-value" id="metric-density"><span class="loading">â€”</span></div>
                </div>
            </div>
            <div class="inline-note">
                These values summarize network diagnostics across independent runs. They indicate signal prevalence, not system health.
            </div>
        </section>

        <!-- Notable Network Observations -->
        <section class="section">
            <div class="section-header">
                <div class="section-question">Question Answered</div>
                <h2 class="section-title">What are the most notable signal-generating contexts?</h2>
            </div>
            <div class="observations-container" id="observations-container">
                <div class="loading" style="padding: var(--space-lg);">Loading...</div>
            </div>
            <div class="inline-note">
                Observations highlight contexts where signals concentrate. These are starting points for investigation, not conclusions.
            </div>
        </section>

        <!-- Network Operation Signals -->
        <section class="section">
            <div class="section-header">
                <div class="section-question">Question Answered</div>
                <h2 class="section-title">Which network operations most frequently emit signals across runs?</h2>
            </div>
            <div class="operations-table-container">
                <table class="operations-table">
                    <thead>
                        <tr>
                            <th>Operation</th>
                            <th>Pass</th>
                            <th>Warn</th>
                            <th>Fail</th>
                            <th>Signal Rate</th>
                        </tr>
                    </thead>
                    <tbody id="operations-tbody">
                        <tr><td colspan="5" class="loading" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="inline-note">
                Operations are aggregated by category. Action labels and evidence are informational and may vary.
            </div>
        </section>

        <!-- Countries by Network Diagnostic Runs -->
        <section class="section">
            <div class="section-header">
                <div class="section-question">Question Answered</div>
                <h2 class="section-title">In which country contexts are network diagnostics occurring, and how noisy?</h2>
            </div>
            <div class="countries-grid" id="countries-grid">
                <div class="loading" style="padding: var(--space-lg);">Loading...</div>
            </div>
            <div class="inline-note">
                Countries represent environmental context, not outcomes. Signal patterns vary by local network conditions.
            </div>
        </section>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <p class="footer-note">
                This dashboard currently presents network-related diagnostics only. Additional diagnostic domains may be added in future sections.
            </p>
        </footer>
    </div>

    <script>
        /**
         * NO Support Tool Dashboard - Live Data Loading
         *
         * IMPORTANT: This dashboard MUST load live data from ./data/index.json
         * Static sample data is NOT acceptable in production.
         * See: ANALYTICS_CONTRACT.md, ARCHITECTURE_MAP.md
         */

        // Country code to flag emoji mapping
        const countryFlags = {
            'US': 'ðŸ‡ºðŸ‡¸', 'CA': 'ðŸ‡¨ðŸ‡¦', 'GB': 'ðŸ‡¬ðŸ‡§', 'DE': 'ðŸ‡©ðŸ‡ª', 'FR': 'ðŸ‡«ðŸ‡·',
            'JP': 'ðŸ‡¯ðŸ‡µ', 'KR': 'ðŸ‡°ðŸ‡·', 'CN': 'ðŸ‡¨ðŸ‡³', 'IN': 'ðŸ‡®ðŸ‡³', 'BR': 'ðŸ‡§ðŸ‡·',
            'AU': 'ðŸ‡¦ðŸ‡º', 'MX': 'ðŸ‡²ðŸ‡½', 'ES': 'ðŸ‡ªðŸ‡¸', 'IT': 'ðŸ‡®ðŸ‡¹', 'NL': 'ðŸ‡³ðŸ‡±',
            'SE': 'ðŸ‡¸ðŸ‡ª', 'NO': 'ðŸ‡³ðŸ‡´', 'DK': 'ðŸ‡©ðŸ‡°', 'FI': 'ðŸ‡«ðŸ‡®', 'PL': 'ðŸ‡µðŸ‡±',
            'RU': 'ðŸ‡·ðŸ‡º', 'ZA': 'ðŸ‡¿ðŸ‡¦', 'SG': 'ðŸ‡¸ðŸ‡¬', 'HK': 'ðŸ‡­ðŸ‡°', 'TW': 'ðŸ‡¹ðŸ‡¼',
            'NZ': 'ðŸ‡³ðŸ‡¿', 'AR': 'ðŸ‡¦ðŸ‡·', 'CL': 'ðŸ‡¨ðŸ‡±', 'CO': 'ðŸ‡¨ðŸ‡´', 'PE': 'ðŸ‡µðŸ‡ª',
            'CH': 'ðŸ‡¨ðŸ‡­', 'AT': 'ðŸ‡¦ðŸ‡¹', 'BE': 'ðŸ‡§ðŸ‡ª', 'IE': 'ðŸ‡®ðŸ‡ª', 'PT': 'ðŸ‡µðŸ‡¹'
        };

        const countryNames = {
            'US': 'United States', 'CA': 'Canada', 'GB': 'United Kingdom', 'DE': 'Germany',
            'FR': 'France', 'JP': 'Japan', 'KR': 'South Korea', 'CN': 'China',
            'IN': 'India', 'BR': 'Brazil', 'AU': 'Australia', 'MX': 'Mexico',
            'ES': 'Spain', 'IT': 'Italy', 'NL': 'Netherlands', 'SE': 'Sweden',
            'NO': 'Norway', 'DK': 'Denmark', 'FI': 'Finland', 'PL': 'Poland',
            'RU': 'Russia', 'ZA': 'South Africa', 'SG': 'Singapore', 'HK': 'Hong Kong',
            'TW': 'Taiwan', 'NZ': 'New Zealand', 'AR': 'Argentina', 'CL': 'Chile',
            'CO': 'Colombia', 'PE': 'Peru', 'CH': 'Switzerland', 'AT': 'Austria',
            'BE': 'Belgium', 'IE': 'Ireland', 'PT': 'Portugal'
        };

        function getFlag(code) {
            return countryFlags[code] || 'ðŸ³ï¸';
        }

        function getCountryName(code, fallbackName) {
            return countryNames[code] || fallbackName || code || 'Unknown';
        }

        /**
         * Load live data from ./data/index.json
         * This is the ONLY acceptable data source for production.
         */
        async function loadLiveData() {
            const index = await fetch('./data/index.json', { cache: 'no-store' }).then(r => {
                if (!r.ok) throw new Error(`Failed to load index.json: ${r.status}`);
                return r.json();
            });

            const runs = await Promise.all(
                index.files.map(file =>
                    fetch(`./data/${file}`, { cache: 'no-store' })
                        .then(r => r.ok ? r.json() : null)
                        .catch(() => null)
                )
            );

            return runs.filter(Boolean);
        }

        /**
         * Aggregate data according to Operation Signals contract
         * - Category = operation (stable, for aggregation)
         * - Action = informational only
         * - Evidence = explanatory only
         */
        function aggregateData(runs) {
            const stats = {
                totalRuns: runs.length,
                countries: new Set(),
                runsWithSignals: 0,
                totalSignals: 0,
                operations: {},      // Category -> { pass, warn, fail }
                countryData: {},     // CountryCode -> { runs, signals, latencies, throughputs, topOp }
                latencyByCountry: {},   // CountryCode -> max latency
                throughputByCountry: {} // CountryCode -> max throughput
            };

            for (const run of runs) {
                if (!run.Actions || !Array.isArray(run.Actions)) continue;

                let runHasSignal = false;
                let runSignalCount = 0;
                const runCountries = new Set();
                const runOperationSignals = {};

                for (const action of run.Actions) {
                    const category = action.Category || 'Unknown';
                    const result = (action.Result || '').toUpperCase();
                    const evidence = action.Evidence || {};
                    const countryCode = evidence.CountryCode || evidence.Country || null;
                    const countryName = evidence.CountryName || null;

                    // Track country
                    if (countryCode) {
                        stats.countries.add(countryCode);
                        runCountries.add(countryCode);

                        // Initialize country data
                        if (!stats.countryData[countryCode]) {
                            stats.countryData[countryCode] = {
                                name: countryName,
                                runs: new Set(),
                                signals: 0,
                                operationSignals: {}
                            };
                        }
                        stats.countryData[countryCode].runs.add(run.SessionId);
                        if (countryName) stats.countryData[countryCode].name = countryName;
                    }

                    // Track operation stats (aggregated by Category)
                    if (!stats.operations[category]) {
                        stats.operations[category] = { pass: 0, warn: 0, fail: 0 };
                    }

                    if (result === 'PASS') {
                        stats.operations[category].pass++;
                    } else if (result === 'WARN') {
                        stats.operations[category].warn++;
                        runHasSignal = true;
                        runSignalCount++;
                        if (countryCode) {
                            stats.countryData[countryCode].signals++;
                            stats.countryData[countryCode].operationSignals[category] =
                                (stats.countryData[countryCode].operationSignals[category] || 0) + 1;
                        }
                    } else if (result === 'FAIL') {
                        stats.operations[category].fail++;
                        runHasSignal = true;
                        runSignalCount++;
                        if (countryCode) {
                            stats.countryData[countryCode].signals++;
                            stats.countryData[countryCode].operationSignals[category] =
                                (stats.countryData[countryCode].operationSignals[category] || 0) + 1;
                        }
                    }

                    // Track latency/throughput extremes for leaderboards
                    if (countryCode && evidence.LatencyMs) {
                        const lat = parseFloat(evidence.LatencyMs);
                        if (!stats.latencyByCountry[countryCode] || lat > stats.latencyByCountry[countryCode]) {
                            stats.latencyByCountry[countryCode] = lat;
                        }
                    }
                    if (countryCode && evidence.LinkSpeedMbps) {
                        const speed = parseFloat(evidence.LinkSpeedMbps);
                        if (!stats.throughputByCountry[countryCode] || speed > stats.throughputByCountry[countryCode]) {
                            stats.throughputByCountry[countryCode] = speed;
                        }
                    }
                }

                if (runHasSignal) {
                    stats.runsWithSignals++;
                }
                stats.totalSignals += runSignalCount;
            }

            // Convert country run sets to counts
            for (const code of Object.keys(stats.countryData)) {
                stats.countryData[code].runCount = stats.countryData[code].runs.size;
            }

            return stats;
        }

        /**
         * Render all dashboard sections with aggregated data
         */
        function renderDashboard(stats) {
            // Network Overview metrics
            document.getElementById('metric-runs').textContent = stats.totalRuns.toLocaleString();
            document.getElementById('metric-countries').textContent = stats.countries.size.toLocaleString();
            document.getElementById('metric-signals').textContent = stats.runsWithSignals.toLocaleString();

            const density = stats.totalRuns > 0 ? (stats.totalSignals / stats.totalRuns).toFixed(1) : '0';
            document.getElementById('metric-density').innerHTML = `${density}<span class="metric-unit">flags/run</span>`;

            // Notable observations
            renderObservations(stats);

            // Operations table
            renderOperationsTable(stats);

            // Countries grid
            renderCountriesGrid(stats);

            // Parse flag emojis with Twemoji for cross-platform consistency
            if (typeof twemoji !== 'undefined') {
                twemoji.parse(document.body, {
                    folder: 'svg',
                    ext: '.svg'
                });
            }
        }

        /**
         * Format signal density with small-N awareness
         * Shows "~X" when sample size is small to avoid false precision
         */
        function formatDensity(density, runs) {
            if (runs < 5) {
                return `~${Math.round(density)}`;
            }
            return density.toFixed(1);
        }

        function renderObservations(stats) {
            const container = document.getElementById('observations-container');

            /*
             * SEVERITY RULE (locked):
             * Severity reflects signal concentration, not certainty.
             * WARN = elevated relative to baseline (density > 1, fail rate > 10%)
             * FAIL = dominant concentration or repeated clustering (density > 2, fail rate > 30%)
             */

            // Find contexts with notable signal patterns
            const observations = [];

            // Provenance tracking
            const totalRuns = stats.totalRuns;
            const totalCountries = stats.countries.size;

            // Find countries with highest signal density (where signals concentrate)
            const countryByDensity = Object.entries(stats.countryData)
                .map(([code, data]) => ({
                    code,
                    name: data.name,
                    density: data.runCount > 0 ? data.signals / data.runCount : 0,
                    signals: data.signals,
                    runs: data.runCount,
                    topOp: Object.entries(data.operationSignals).sort((a, b) => b[1] - a[1])[0]
                }))
                .filter(c => c.signals > 0)
                .sort((a, b) => b.density - a.density);

            // Find operations with highest fail rates
            const opsByFailRate = Object.entries(stats.operations)
                .map(([op, counts]) => ({
                    op,
                    total: counts.pass + counts.warn + counts.fail,
                    fails: counts.fail,
                    warns: counts.warn,
                    failRate: (counts.pass + counts.warn + counts.fail) > 0
                        ? counts.fail / (counts.pass + counts.warn + counts.fail) : 0
                }))
                .filter(o => o.fails > 0)
                .sort((a, b) => b.failRate - a.failRate);

            // Build observations (max 3)
            if (countryByDensity.length > 0) {
                const top = countryByDensity[0];
                observations.push({
                    flag: getFlag(top.code),
                    country: getCountryName(top.code, top.name),
                    headline: `${getCountryName(top.code, top.name)} has the highest signal concentration`,
                    detail: `${formatDensity(top.density, top.runs)} signals per run across ${top.runs} diagnostic runs. Most frequent signal: ${top.topOp ? top.topOp[0] : 'various'}.`,
                    severity: top.density > 2 ? 'fail' : 'warn',
                    meta: [`${top.signals} total signals`, `${top.runs} runs`]
                });
            }

            if (opsByFailRate.length > 0 && opsByFailRate[0].failRate > 0.1) {
                const top = opsByFailRate[0];
                observations.push({
                    flag: 'âš ï¸',
                    headline: `${top.op} shows elevated failure rate`,
                    detail: `${(top.failRate * 100).toFixed(0)}% of ${top.op} operations resulted in FAIL signals. Consider investigating common environmental factors.`,
                    severity: top.failRate > 0.3 ? 'fail' : 'warn',
                    meta: [`${top.fails} failures`, `${top.total} total`]
                });
            }

            // Add a second country if notably different
            if (countryByDensity.length > 1 && countryByDensity[1].density > 1) {
                const second = countryByDensity[1];
                observations.push({
                    flag: getFlag(second.code),
                    country: getCountryName(second.code, second.name),
                    headline: `${getCountryName(second.code, second.name)} also shows signal clustering`,
                    detail: `${formatDensity(second.density, second.runs)} signals per run. Most frequent signal: ${second.topOp ? second.topOp[0] : 'various'}.`,
                    severity: 'warn',
                    meta: [`${second.signals} signals`, `${second.runs} runs`]
                });
            }

            if (observations.length === 0) {
                container.innerHTML = '<div class="observation-empty">No notable signal concentrations detected in current data.</div>';
                return;
            }

            // Provenance line
            const provenance = `Derived from ${totalRuns} runs across ${totalCountries} ${totalCountries === 1 ? 'country' : 'countries'}`;

            container.innerHTML = observations.slice(0, 3).map(obs => `
                <div class="observation-card severity-${obs.severity}">
                    <span class="observation-flag">${obs.flag}</span>
                    <div class="observation-content">
                        <div class="observation-headline">${obs.headline}</div>
                        <div class="observation-detail">${obs.detail}</div>
                        <div class="observation-meta">
                            ${obs.meta.map(m => `<span>${m}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('') + `<div class="observation-provenance">${provenance}</div>`;
        }

        function renderOperationsTable(stats) {
            const tbody = document.getElementById('operations-tbody');
            const operations = Object.entries(stats.operations)
                .sort((a, b) => {
                    const aSignals = a[1].warn + a[1].fail;
                    const bSignals = b[1].warn + b[1].fail;
                    return bSignals - aSignals;
                });

            if (operations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-tertiary);">No operation data available</td></tr>';
                return;
            }

            tbody.innerHTML = operations.map(([category, counts]) => {
                const total = counts.pass + counts.warn + counts.fail;
                const signalRate = total > 0 ? ((counts.warn + counts.fail) / total * 100) : 0;
                return `
                    <tr>
                        <td class="operation-name">${category}</td>
                        <td><span class="signal-count pass">${counts.pass.toLocaleString()}</span></td>
                        <td><span class="signal-count warn">${counts.warn.toLocaleString()}</span></td>
                        <td><span class="signal-count fail">${counts.fail.toLocaleString()}</span></td>
                        <td class="signal-rate">
                            <span class="signal-rate-bar"><span class="signal-rate-fill" style="width: ${Math.min(signalRate, 100).toFixed(0)}%"></span></span>
                            ${signalRate.toFixed(1)}%
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderCountriesGrid(stats) {
            const grid = document.getElementById('countries-grid');
            const countries = Object.entries(stats.countryData)
                .sort((a, b) => b[1].runCount - a[1].runCount);

            if (countries.length === 0) {
                grid.innerHTML = '<div style="padding: var(--space-lg); color: var(--text-tertiary);">No country data available</div>';
                return;
            }

            // Sort by signal density (most signals per run first) to surface investigation priorities
            const sortedCountries = countries.sort((a, b) => {
                const densityA = a[1].runCount > 0 ? a[1].signals / a[1].runCount : 0;
                const densityB = b[1].runCount > 0 ? b[1].signals / b[1].runCount : 0;
                return densityB - densityA;
            });

            grid.innerHTML = sortedCountries.map(([code, data]) => {
                const rawDensity = data.runCount > 0 ? data.signals / data.runCount : 0;
                const density = formatDensity(rawDensity, data.runCount);
                const topOp = Object.entries(data.operationSignals)
                    .sort((a, b) => b[1] - a[1])[0];
                const topOpName = topOp ? topOp[0] : 'None';
                const hasSignals = data.signals > 0;

                return `
                    <div class="country-card">
                        <div class="country-header">
                            <span class="country-flag" title="${getCountryName(code, data.name)}">${getFlag(code)}</span>
                            <span class="country-name">${getCountryName(code, data.name)}</span>
                        </div>
                        <div class="country-metrics">
                            ${hasSignals ? `
                            <div class="country-metric full-width" style="margin-top: 0; padding-top: 0; border-top: none;">
                                <div class="country-metric-label">Most Frequent Signal</div>
                                <span class="top-operation">
                                    <span class="top-operation-dot"></span>
                                    ${topOpName}
                                </span>
                            </div>
                            ` : ''}
                            <div class="country-metric">
                                <div class="country-metric-label">Signal Density</div>
                                <div class="country-metric-value">${density}<span class="metric-unit" style="font-size: 0.65rem;">/run</span></div>
                            </div>
                            <div class="country-metric">
                                <div class="country-metric-label">Total Signals</div>
                                <div class="country-metric-value">${data.signals.toLocaleString()}</div>
                            </div>
                            <div class="country-metric">
                                <div class="country-metric-label">Diagnostic Runs</div>
                                <div class="country-metric-value">${data.runCount.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Show error state - NEVER silently fall back to static data
         */
        function showError(message) {
            const banner = document.getElementById('error-banner');
            banner.textContent = `Live data unavailable: ${message}. Check data/index.json or GitHub Pages deployment.`;
            banner.style.display = 'block';

            // Set empty states
            document.getElementById('metric-runs').textContent = 'â€”';
            document.getElementById('metric-countries').textContent = 'â€”';
            document.getElementById('metric-signals').textContent = 'â€”';
            document.getElementById('metric-density').textContent = 'â€”';
            document.getElementById('observations-container').innerHTML = '<div class="observation-empty">Data unavailable</div>';
            document.getElementById('operations-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-tertiary);">Data unavailable</td></tr>';
            document.getElementById('countries-grid').innerHTML = '<div style="padding: var(--space-lg); color: var(--text-tertiary);">Data unavailable</div>';
        }

        /**
         * Initialize dashboard on page load
         */
        async function init() {
            try {
                const runs = await loadLiveData();
                const stats = aggregateData(runs);
                renderDashboard(stats);
            } catch (err) {
                console.error('Dashboard data load failed:', err);
                showError(err.message);
            }
        }

        // Load data when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
