<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NO Support Tool — Network Diagnostics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Twemoji for cross-platform flag emoji support -->
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <style>
        /* Twemoji flag sizing */
        img.emoji {
            height: 1em;
            width: 1em;
            margin: 0 .05em 0 .1em;
            vertical-align: -0.1em;
        }

        .leaderboard-flag img.emoji,
        .country-flag img.emoji {
            height: 1.2em;
            width: 1.2em;
        }

        .country-flag img.emoji {
            height: 1.75em;
            width: 1.75em;
        }
        :root {
            /* Base palette - observatory/instrumentation */
            --bg-primary: #0a0c0f;
            --bg-secondary: #12151a;
            --bg-tertiary: #1a1e25;
            --bg-elevated: #222830;

            /* Text hierarchy */
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-tertiary: #5f6368;
            --text-muted: #3c4043;

            /* Signal colors - intentionally muted/observational */
            --signal-pass: #4a9f7e;
            --signal-pass-bg: rgba(74, 159, 126, 0.12);
            --signal-warn: #c9a227;
            --signal-warn-bg: rgba(201, 162, 39, 0.12);
            --signal-fail: #b86a5c;
            --signal-fail-bg: rgba(184, 106, 92, 0.12);

            /* Accent - cool teal for interactive/highlight */
            --accent: #5c9aa8;
            --accent-dim: rgba(92, 154, 168, 0.15);

            /* Borders */
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-default: rgba(255, 255, 255, 0.1);
            --border-strong: rgba(255, 255, 255, 0.15);

            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;

            /* Spacing scale */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;

            /* Grid */
            --grid-gap: 20px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Subtle scan line effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* Layout */
        .dashboard {
            max-width: 1440px;
            margin: 0 auto;
            padding: var(--space-xl);
        }

        /* Header */
        .header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-2xl);
            padding-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-main {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 11px;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 500;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .header-title .subtitle {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            font-weight: 400;
            margin-top: 2px;
        }

        /* Domain nav */
        .domain-nav {
            display: flex;
            gap: var(--space-xs);
        }

        .domain-tab {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .domain-tab:hover {
            border-color: var(--border-default);
            color: var(--text-secondary);
        }

        .domain-tab.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        .domain-tab.future {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Section structure */
        .section {
            margin-bottom: var(--space-2xl);
        }

        .section-header {
            margin-bottom: var(--space-lg);
        }

        .section-question {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            margin-bottom: var(--space-xs);
            opacity: 0.8;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        /* Metric cards grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--grid-gap);
        }

        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: var(--space-lg);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent) 0%, transparent 100%);
            opacity: 0.5;
        }

        .metric-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .metric-value {
            font-family: var(--font-mono);
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            line-height: 1;
        }

        .metric-unit {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: var(--space-xs);
        }

        /* Inline notes */
        .inline-note {
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-left: 2px solid var(--border-default);
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .inline-note.error {
            border-left-color: var(--signal-fail);
            color: var(--signal-fail);
        }

        /* Notable observations section */
        .observations-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .observation-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--signal-warn);
            border-radius: 0 8px 8px 0;
            padding: var(--space-md) var(--space-lg);
            display: flex;
            align-items: flex-start;
            gap: var(--space-lg);
        }

        .observation-card.severity-fail {
            border-left-color: var(--signal-fail);
        }

        .observation-card.severity-warn {
            border-left-color: var(--signal-warn);
        }

        .observation-flag {
            font-size: 1.5rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .observation-content {
            flex: 1;
            min-width: 0;
        }

        .observation-headline {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .observation-detail {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .observation-meta {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-sm);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .observation-empty {
            color: var(--text-tertiary);
            font-size: 0.85rem;
            padding: var(--space-lg);
            text-align: center;
        }

        .observation-provenance {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-tertiary);
            text-align: right;
            margin-top: var(--space-sm);
            font-style: italic;
        }

        /* Operations table */
        .operations-table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            overflow: hidden;
        }

        .operations-table {
            width: 100%;
            border-collapse: collapse;
        }

        .operations-table th {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-tertiary);
            text-align: left;
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 500;
        }

        .operations-table th:not(:first-child) {
            text-align: center;
        }

        .operations-table td {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.85rem;
        }

        .operations-table td:not(:first-child) {
            text-align: center;
            font-family: var(--font-mono);
        }

        .operations-table tr:last-child td {
            border-bottom: none;
        }

        .operations-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .operation-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .signal-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            padding: var(--space-xs) var(--space-sm);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .signal-count.pass {
            background: var(--signal-pass-bg);
            color: var(--signal-pass);
        }

        .signal-count.warn {
            background: var(--signal-warn-bg);
            color: var(--signal-warn);
        }

        .signal-count.fail {
            background: var(--signal-fail-bg);
            color: var(--signal-fail);
        }

        .signal-rate {
            color: var(--text-secondary);
        }

        .signal-rate-bar {
            display: inline-block;
            width: 60px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-right: var(--space-sm);
            overflow: hidden;
            vertical-align: middle;
        }

        .signal-rate-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Countries grid */
        .countries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--grid-gap);
        }

        .country-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: var(--space-lg);
            transition: border-color 0.2s ease;
        }

        .country-card:hover {
            border-color: var(--border-default);
        }

        .country-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-subtle);
        }

        .country-flag {
            font-size: 1.75rem;
            line-height: 1;
        }

        .country-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .country-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }

        .country-metric {
            padding: var(--space-sm) 0;
        }

        .country-metric-label {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: var(--space-xs);
        }

        .country-metric-value {
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .country-metric.full-width {
            grid-column: span 2;
            padding-top: var(--space-md);
            margin-top: var(--space-sm);
            border-top: 1px solid var(--border-subtle);
        }

        .top-operation {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .top-operation-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--signal-warn);
        }

        /* Footer */
        .dashboard-footer {
            margin-top: var(--space-2xl);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-subtle);
            text-align: center;
        }

        .footer-note {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Loading state */
        .loading {
            color: var(--text-tertiary);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: var(--space-md);
            }

            .header {
                flex-direction: column;
                gap: var(--space-lg);
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .domain-nav {
                flex-wrap: wrap;
            }
        }

        /* Loading animation for initial render */
        .section {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.4s ease forwards;
        }

        .section:nth-child(1) { animation-delay: 0.1s; }
        .section:nth-child(2) { animation-delay: 0.2s; }
        .section:nth-child(3) { animation-delay: 0.3s; }
        .section:nth-child(4) { animation-delay: 0.4s; }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tab content visibility */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Bluetooth-specific styles */

        /* Verdict Banner */
        .verdict-banner {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .verdict-badge {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 600;
            padding: var(--space-sm) var(--space-md);
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            flex-shrink: 0;
        }

        .verdict-badge.ready {
            background: var(--signal-pass-bg);
            color: var(--signal-pass);
            border: 1px solid var(--signal-pass);
        }

        .verdict-badge.degraded {
            background: var(--signal-warn-bg);
            color: var(--signal-warn);
            border: 1px solid var(--signal-warn);
        }

        .verdict-badge.unsuitable {
            background: var(--signal-fail-bg);
            color: var(--signal-fail);
            border: 1px solid var(--signal-fail);
        }

        .verdict-summary {
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .verdict-confidence {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-left: auto;
            flex-shrink: 0;
        }

        /* Status section */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.85rem;
        }

        .status-label {
            color: var(--text-secondary);
        }

        .status-value {
            font-family: var(--font-mono);
            color: var(--text-primary);
        }

        .status-value.ok {
            color: var(--signal-pass);
        }

        .status-value.warn {
            color: var(--signal-warn);
        }

        .status-value.fail {
            color: var(--signal-fail);
        }

        /* Service list */
        .service-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .service-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .service-name {
            color: var(--text-secondary);
        }

        .service-status {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .service-status.running {
            color: var(--signal-pass);
        }

        .service-status.stopped {
            color: var(--signal-fail);
        }

        /* Reset buttons */
        .reset-section {
            margin-bottom: var(--space-lg);
        }

        .reset-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .reset-btn {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .reset-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-strong);
        }

        .reset-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .reset-tier {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .reset-tier.tier-1 {
            background: var(--signal-pass-bg);
            color: var(--signal-pass);
        }

        .reset-tier.tier-2 {
            background: var(--signal-warn-bg);
            color: var(--signal-warn);
        }

        .reset-tier.tier-3 {
            background: var(--signal-fail-bg);
            color: var(--signal-fail);
        }

        .reset-content {
            flex: 1;
        }

        .reset-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .reset-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* Kodi summary */
        .kodi-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .kodi-item {
            font-size: 0.85rem;
        }

        .kodi-label {
            color: var(--text-tertiary);
            font-size: 0.75rem;
        }

        .kodi-value {
            font-family: var(--font-mono);
            color: var(--text-primary);
        }

        .kodi-value .warning-icon {
            color: var(--signal-warn);
            margin-left: var(--space-xs);
        }

        /* Collapsible advanced details */
        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 0.75rem;
            cursor: pointer;
            padding: var(--space-sm) 0;
        }

        .advanced-toggle:hover {
            color: var(--text-secondary);
        }

        .advanced-toggle .chevron {
            transition: transform 0.2s ease;
        }

        .advanced-toggle.open .chevron {
            transform: rotate(90deg);
        }

        .advanced-content {
            display: none;
            margin-top: var(--space-sm);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow-x: auto;
        }

        .advanced-content.open {
            display: block;
        }

        /* Active probe section */
        .probe-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: var(--space-lg);
        }

        .probe-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .probe-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .probe-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .probe-btn {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            border-radius: 6px;
            color: var(--accent);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .probe-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .probe-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .probe-status {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-tertiary);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .probe-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--bg-primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 4px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .probe-btn:disabled {
            background: var(--accent);
            color: var(--bg-primary);
            cursor: wait;
        }

        /* Probe progress banner */
        .probe-progress-banner {
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: var(--space-md) var(--space-lg);
            margin-bottom: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .probe-progress-icon {
            flex-shrink: 0;
        }

        .probe-progress-text {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .probe-progress-text strong {
            color: var(--accent);
        }

        .probe-progress-hint {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-style: italic;
        }

        /* Gated buttons during probe */
        .reset-btn.gated {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .reset-btn.gated::after {
            content: ' (probe running)';
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        /* Copy button */
        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-strong);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            background: var(--signal-pass-bg);
            border-color: var(--signal-pass);
            color: var(--signal-pass);
        }

        /* Findings list */
        .findings-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .finding-card {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: 6px;
            border-left: 3px solid var(--border-default);
        }

        .finding-card.severity-fail {
            border-left-color: var(--signal-fail);
        }

        .finding-card.severity-warn {
            border-left-color: var(--signal-warn);
        }

        .finding-card.severity-info {
            border-left-color: var(--accent);
        }

        .finding-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .finding-content {
            flex: 1;
        }

        .finding-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .finding-evidence {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .finding-action {
            font-size: 0.75rem;
            color: var(--accent);
            margin-top: var(--space-xs);
            font-style: italic;
        }

        /* Driver/adapter info */
        .hw-info {
            display: flex;
            gap: var(--space-lg);
            flex-wrap: wrap;
        }

        .hw-item {
            font-size: 0.8rem;
        }

        .hw-label {
            color: var(--text-tertiary);
            font-size: 0.7rem;
            display: block;
        }

        .hw-value {
            font-family: var(--font-mono);
            color: var(--text-secondary);
        }

        /* ==================== SUPPORT DECISION DASHBOARD STYLES ==================== */

        /* Network Verdict Banner */
        .network-verdict-banner {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .verdict-indicator {
            font-size: 2rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .verdict-content {
            flex: 1;
        }

        .verdict-primary {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            display: block;
        }

        .verdict-meta {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: var(--space-xs);
            display: block;
        }

        .verdict-primary.environment-likely { color: var(--signal-warn); }
        .verdict-primary.network-likely { color: #e8a855; }
        .verdict-primary.system-likely { color: var(--signal-fail); }
        .verdict-primary.inconclusive { color: var(--text-secondary); }

        /* Recommended Actions */
        .actions-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .action-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
        }

        .action-step {
            background: var(--accent);
            color: var(--bg-primary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .action-content {
            flex: 1;
        }

        .action-text {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .action-outcome {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .action-confirms {
            font-size: 0.75rem;
            color: var(--accent);
            font-style: italic;
            margin-top: var(--space-xs);
        }

        /* Failure Attribution Table */
        .attribution-table {
            width: 100%;
            border-collapse: collapse;
        }

        .attribution-table th {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-tertiary);
            text-align: left;
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 500;
        }

        .attribution-table td {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.85rem;
        }

        .attribution-table tr:last-child td {
            border-bottom: none;
        }

        .attribution-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .failure-pattern {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .failure-pattern.repeated {
            background: var(--signal-fail-bg);
            color: var(--signal-fail);
        }

        .failure-pattern.intermittent {
            background: var(--signal-warn-bg);
            color: var(--signal-warn);
        }

        .failure-pattern.isolated {
            background: var(--accent-dim);
            color: var(--accent);
        }

        .failure-pattern.warn-only {
            background: var(--signal-warn-bg);
            color: var(--signal-warn);
        }

        .owner-cell {
            font-weight: 500;
        }

        .owner-cell.client { color: var(--signal-warn); }
        .owner-cell.network { color: #e8a855; }
        .owner-cell.system { color: var(--signal-fail); }

        /* Environment Context Cards */
        .environment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--grid-gap);
        }

        .environment-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: var(--space-lg);
            transition: border-color 0.2s ease;
        }

        .environment-card:hover {
            border-color: var(--border-default);
        }

        .env-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-subtle);
        }

        .env-classification {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-left: auto;
        }

        .env-classification.stable {
            background: var(--signal-pass-bg);
            color: var(--signal-pass);
        }

        .env-classification.noisy {
            background: var(--signal-warn-bg);
            color: var(--signal-warn);
        }

        .env-classification.high-risk {
            background: var(--signal-fail-bg);
            color: var(--signal-fail);
        }

        .env-classification.insufficient-data {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
        }

        .env-known-issues,
        .env-support-note {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            line-height: 1.5;
        }

        .env-known-issues strong,
        .env-support-note strong {
            color: var(--text-tertiary);
            font-weight: 500;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .env-stats {
            display: flex;
            gap: var(--space-lg);
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-subtle);
        }

        .env-stat {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .env-stat-value {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Notable Patterns Section */
        .patterns-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .pattern-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--accent);
            border-radius: 0 8px 8px 0;
            padding: var(--space-md) var(--space-lg);
        }

        .pattern-observation {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .pattern-suggestion {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .pattern-suggestion::before {
            content: '→ ';
            color: var(--accent);
        }

        .patterns-empty {
            color: var(--text-tertiary);
            font-size: 0.85rem;
            padding: var(--space-lg);
            text-align: center;
        }

        /* Section titles without "Question Answered" */
        .section-title-simple {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            margin-bottom: var(--space-lg);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-main">
                <div class="logo">NO</div>
                <div class="header-title">
                    <h1>NO Support Tool</h1>
                    <div class="subtitle">Support Decision Dashboard</div>
                </div>
            </div>
            <nav class="domain-nav">
                <button class="domain-tab active" data-tab="network">Network</button>
                <button class="domain-tab" data-tab="bluetooth">Bluetooth</button>
                <button class="domain-tab future" title="Coming soon">System</button>
                <button class="domain-tab future" title="Coming soon">Permissions</button>
                <button class="domain-tab future" title="Coming soon">Environment</button>
                <button class="domain-tab future" title="Coming soon">Hardware</button>
            </nav>
        </header>

        <!-- Error Banner (hidden by default) -->
        <div id="error-banner" class="inline-note error" style="display: none; margin-bottom: var(--space-lg);"></div>

        <!-- ==================== NETWORK TAB ==================== -->
        <div id="network-tab" class="tab-content active">

        <!-- 1. Support Verdict Banner (Required) -->
        <div class="network-verdict-banner" id="network-verdict-banner">
            <span class="verdict-indicator" id="verdict-indicator">&#128993;</span>
            <div class="verdict-content">
                <span class="verdict-primary" id="verdict-primary">Loading...</span>
                <span class="verdict-meta" id="verdict-meta">Analyzing diagnostic data...</span>
            </div>
        </div>

        <!-- 2. Recommended Support Actions -->
        <section class="section">
            <h2 class="section-title-simple">Recommended Support Actions</h2>
            <ol class="actions-list" id="actions-list">
                <li class="action-item">
                    <span class="action-step">-</span>
                    <div class="action-content">
                        <div class="action-text loading">Loading recommendations...</div>
                    </div>
                </li>
            </ol>
        </section>

        <!-- 3. Failure Attribution Summary -->
        <section class="section">
            <h2 class="section-title-simple">Failure Attribution Summary</h2>
            <div class="operations-table-container">
                <table class="attribution-table">
                    <thead>
                        <tr>
                            <th>Diagnostic Area</th>
                            <th>Failure Pattern</th>
                            <th>Likely Owner</th>
                            <th>Support Meaning</th>
                        </tr>
                    </thead>
                    <tbody id="attribution-tbody">
                        <tr><td colspan="4" class="loading" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="inline-note">
                Only diagnostic areas with failures or warnings are shown. WARN results are not failures.
            </div>
        </section>

        <!-- 4. Observed Network Environments -->
        <section class="section">
            <h2 class="section-title-simple">Observed Network Environments</h2>
            <div class="environment-grid" id="environment-grid">
                <div class="loading" style="padding: var(--space-lg);">Loading...</div>
            </div>
            <div class="inline-note">
                Classification is derived from diagnostic data. Known issues are institutional knowledge, not conclusions.
            </div>
        </section>

        <!-- 5. Notable Patterns (System Learning Only) -->
        <section class="section">
            <h2 class="section-title-simple">Notable Patterns</h2>
            <div class="inline-note" style="margin-bottom: var(--space-md);">
                For systemic improvement — not live ticket resolution.
            </div>
            <div class="patterns-list" id="patterns-list">
                <div class="patterns-empty">No notable patterns detected in current data.</div>
            </div>
        </section>

        </div><!-- End Network Tab -->

        <!-- ==================== BLUETOOTH TAB ==================== -->
        <div id="bluetooth-tab" class="tab-content">

            <!-- Probe In Progress Banner (hidden by default) -->
            <div class="probe-progress-banner" id="bt-probe-progress" style="display: none;">
                <span class="probe-progress-icon"><span class="probe-spinner"></span></span>
                <span class="probe-progress-text">Active Probe: <strong>Running</strong> (<span id="bt-probe-countdown">00:30</span> remaining)</span>
                <span class="probe-progress-hint">Reset actions disabled during probe</span>
            </div>

            <!-- Verdict Banner (P0 UI requirement) -->
            <div class="verdict-banner" id="bt-verdict-banner">
                <span class="verdict-badge degraded" id="bt-verdict-badge">DEGRADED</span>
                <span class="verdict-summary" id="bt-verdict-summary">Bluetooth audio is currently DEGRADED due to Hands-Free routing.</span>
                <span class="verdict-confidence" id="bt-verdict-confidence">Confidence: High</span>
                <button class="copy-btn" id="bt-copy-summary" title="Copy Bluetooth Summary">
                    <span class="copy-icon">&#128203;</span> Copy Summary
                </button>
            </div>

            <!-- Bluetooth Status Section (above Safe Resets) -->
            <section class="section">
                <div class="section-header">
                    <div class="section-question">Current State</div>
                    <h2 class="section-title">Bluetooth Status</h2>
                </div>
                <div class="metric-card" style="margin-bottom: var(--space-md);">
                    <div class="status-grid" id="bt-status-grid">
                        <div class="status-item">
                            <span class="status-label">Adapter:</span>
                            <span class="status-value ok" id="bt-adapter-status">OK</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Audio routing:</span>
                            <span class="status-value warn" id="bt-audio-routing">DEGRADED (Hands-Free)</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Kodi audio path:</span>
                            <span class="status-value warn" id="bt-kodi-path">Mismatch detected</span>
                        </div>
                    </div>
                </div>

                <!-- Services List with [OK] indicators -->
                <div class="section-header" style="margin-top: var(--space-lg);">
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary);">Services</h3>
                </div>
                <div class="service-list" id="bt-service-list">
                    <div class="service-item">
                        <span class="service-name">Bluetooth Support Service (bthserv)</span>
                        <span class="service-status running">[OK]</span>
                    </div>
                    <div class="service-item">
                        <span class="service-name">Bluetooth Audio Gateway (BTAGService)</span>
                        <span class="service-status running">[OK]</span>
                    </div>
                    <div class="service-item">
                        <span class="service-name">Windows Audio (Audiosrv)</span>
                        <span class="service-status running">[OK]</span>
                    </div>
                    <div class="service-item">
                        <span class="service-name">Audio Endpoint Builder</span>
                        <span class="service-status running">[OK]</span>
                    </div>
                </div>

                <!-- Driver + Adapter Info (surfaced once) -->
                <div class="section-header" style="margin-top: var(--space-lg);">
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary);">Hardware</h3>
                </div>
                <div class="hw-info" id="bt-hw-info">
                    <div class="hw-item">
                        <span class="hw-label">Adapter</span>
                        <span class="hw-value" id="bt-adapter-name">Intel Wireless Bluetooth</span>
                    </div>
                    <div class="hw-item">
                        <span class="hw-label">Driver Version</span>
                        <span class="hw-value" id="bt-driver-version">22.180.0.4</span>
                    </div>
                    <div class="hw-item">
                        <span class="hw-label">Driver Date</span>
                        <span class="hw-value" id="bt-driver-date">2023-08-15</span>
                    </div>
                </div>
            </section>

            <!-- Top Findings -->
            <section class="section">
                <div class="section-header">
                    <div class="section-question">Issues Detected</div>
                    <h2 class="section-title">Top Findings</h2>
                </div>
                <div class="findings-list" id="bt-findings-list">
                    <div class="finding-card severity-warn">
                        <span class="finding-icon">&#9888;</span>
                        <div class="finding-content">
                            <div class="finding-title">Hands-Free Profile Active</div>
                            <div class="finding-evidence">HFP provides mono 8kHz audio. Stereo A2DP profile preferred.</div>
                            <div class="finding-action">Switch to Stereo output in Windows Sound settings</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Kodi Audio Settings -->
            <section class="section">
                <div class="section-header">
                    <div class="section-question">Application Config</div>
                    <h2 class="section-title">Kodi Audio Settings</h2>
                </div>
                <div class="metric-card">
                    <!-- Curated Summary (above raw dump) -->
                    <div class="section-header" style="margin-bottom: var(--space-md);">
                        <h3 style="font-size: 0.85rem; color: var(--text-secondary);">Kodi Audio Summary</h3>
                    </div>
                    <div class="kodi-summary" id="bt-kodi-summary">
                        <div class="kodi-item">
                            <div class="kodi-label">Output device</div>
                            <div class="kodi-value" id="bt-kodi-output">DirectSound: default</div>
                        </div>
                        <div class="kodi-item">
                            <div class="kodi-label">Passthrough</div>
                            <div class="kodi-value" id="bt-kodi-passthrough">ENABLED <span class="warning-icon">&#9888;</span> (incompatible with Bluetooth)</div>
                        </div>
                        <div class="kodi-item">
                            <div class="kodi-label">Channels</div>
                            <div class="kodi-value" id="bt-kodi-channels">Mono</div>
                        </div>
                    </div>

                    <!-- Advanced Details (collapsed by default) -->
                    <button class="advanced-toggle" id="bt-kodi-advanced-toggle">
                        <span class="chevron">&#9654;</span> Advanced Details
                    </button>
                    <div class="advanced-content" id="bt-kodi-advanced-content">
                        <pre id="bt-kodi-raw">audiooutput.audiodevice = DirectSound:default
audiooutput.passthroughdevice = DirectSound:default
audiooutput.passthrough = true
audiooutput.channels = 1
audiooutput.guisoundmode = 0
audiooutput.streamsilence = 0</pre>
                    </div>
                </div>
            </section>

            <!-- Safe Resets (moved down, still visible) -->
            <section class="section reset-section">
                <div class="section-header">
                    <div class="section-question">Remediation</div>
                    <h2 class="section-title">Safe Resets</h2>
                </div>
                <div class="reset-buttons">
                    <!-- Tier 1 - Green -->
                    <button class="reset-btn" id="bt-reset-tier1">
                        <span class="reset-tier tier-1">Tier 1</span>
                        <div class="reset-content">
                            <div class="reset-title">Restart Bluetooth + Audio Services</div>
                            <div class="reset-desc">Safe restart of bthserv, BTAGService, and audio services. No reboot required.</div>
                        </div>
                    </button>

                    <!-- Tier 2 - Yellow -->
                    <button class="reset-btn" id="bt-reset-tier2">
                        <span class="reset-tier tier-2">Tier 2</span>
                        <div class="reset-content">
                            <div class="reset-title">Remove Stale BT Audio Endpoints</div>
                            <div class="reset-desc">Cleans disconnected Bluetooth audio devices. May require re-pairing.</div>
                        </div>
                    </button>

                    <!-- Tier 3 - Red (label tightened per feedback) -->
                    <button class="reset-btn" id="bt-reset-tier3">
                        <span class="reset-tier tier-3">Tier 3</span>
                        <div class="reset-content">
                            <div class="reset-title">Reset Bluetooth Adapter (Last resort &#8211; reboot required)</div>
                            <div class="reset-desc">Disables and re-enables the Bluetooth adapter. Disconnects all paired devices.</div>
                        </div>
                    </button>
                </div>
            </section>

            <!-- Active Probe (isolated at bottom) -->
            <section class="section">
                <div class="probe-section">
                    <div class="probe-header">
                        <div>
                            <div class="probe-title">Active Probe</div>
                            <div class="probe-subtitle">Confirms Bluetooth stability under real audio playback.</div>
                        </div>
                        <button class="probe-btn" id="bt-probe-btn">
                            <span>&#9654;</span> Run 30s Probe
                        </button>
                    </div>
                    <div class="probe-status" id="bt-probe-status">
                        Not started. Click "Run 30s Probe" to test Bluetooth audio stability during silent playback.
                    </div>
                </div>
            </section>

        </div><!-- End Bluetooth Tab -->

        <!-- Footer -->
        <footer class="dashboard-footer">
            <p class="footer-note">
                This dashboard converts diagnostics into support decisions. If a panel doesn't change a support decision, it doesn't belong here.
            </p>
        </footer>
    </div>

    <script>
        /**
         * NO Support Tool Dashboard - Live Data Loading
         *
         * IMPORTANT: This dashboard MUST load live data from ./data/index.json
         * Static sample data is NOT acceptable in production.
         * See: ANALYTICS_CONTRACT.md, ARCHITECTURE_MAP.md
         */

        // Country code to flag emoji mapping
        const countryFlags = {
            'US': '🇺🇸', 'CA': '🇨🇦', 'GB': '🇬🇧', 'DE': '🇩🇪', 'FR': '🇫🇷',
            'JP': '🇯🇵', 'KR': '🇰🇷', 'CN': '🇨🇳', 'IN': '🇮🇳', 'BR': '🇧🇷',
            'AU': '🇦🇺', 'MX': '🇲🇽', 'ES': '🇪🇸', 'IT': '🇮🇹', 'NL': '🇳🇱',
            'SE': '🇸🇪', 'NO': '🇳🇴', 'DK': '🇩🇰', 'FI': '🇫🇮', 'PL': '🇵🇱',
            'RU': '🇷🇺', 'ZA': '🇿🇦', 'SG': '🇸🇬', 'HK': '🇭🇰', 'TW': '🇹🇼',
            'NZ': '🇳🇿', 'AR': '🇦🇷', 'CL': '🇨🇱', 'CO': '🇨🇴', 'PE': '🇵🇪',
            'CH': '🇨🇭', 'AT': '🇦🇹', 'BE': '🇧🇪', 'IE': '🇮🇪', 'PT': '🇵🇹'
        };

        const countryNames = {
            'US': 'United States', 'CA': 'Canada', 'GB': 'United Kingdom', 'DE': 'Germany',
            'FR': 'France', 'JP': 'Japan', 'KR': 'South Korea', 'CN': 'China',
            'IN': 'India', 'BR': 'Brazil', 'AU': 'Australia', 'MX': 'Mexico',
            'ES': 'Spain', 'IT': 'Italy', 'NL': 'Netherlands', 'SE': 'Sweden',
            'NO': 'Norway', 'DK': 'Denmark', 'FI': 'Finland', 'PL': 'Poland',
            'RU': 'Russia', 'ZA': 'South Africa', 'SG': 'Singapore', 'HK': 'Hong Kong',
            'TW': 'Taiwan', 'NZ': 'New Zealand', 'AR': 'Argentina', 'CL': 'Chile',
            'CO': 'Colombia', 'PE': 'Peru', 'CH': 'Switzerland', 'AT': 'Austria',
            'BE': 'Belgium', 'IE': 'Ireland', 'PT': 'Portugal'
        };

        function getFlag(code) {
            return countryFlags[code] || '🏳️';
        }

        function getCountryName(code, fallbackName) {
            return countryNames[code] || fallbackName || code || 'Unknown';
        }

        /**
         * Load live data from ./data/index.json
         * This is the ONLY acceptable data source for production.
         */
        async function loadLiveData() {
            const index = await fetch('./data/index.json', { cache: 'no-store' }).then(r => {
                if (!r.ok) throw new Error(`Failed to load index.json: ${r.status}`);
                return r.json();
            });

            const runs = await Promise.all(
                index.files.map(file =>
                    fetch(`./data/${file}`, { cache: 'no-store' })
                        .then(r => r.ok ? r.json() : null)
                        .catch(() => null)
                )
            );

            return runs.filter(Boolean);
        }

        // ==================== SUPPORT DECISION ENGINE ====================

        /**
         * Static institutional knowledge (human-curated)
         * Known issues and support notes per country
         */
        const countryKnowledge = {
            'CA': {
                knownIssues: ['VPN use common', 'ISP DNS filtering'],
                supportNote: 'Ask about VPN first'
            },
            'US': {
                knownIssues: ['Corporate proxy common'],
                supportNote: 'Check proxy settings if in corporate environment'
            },
            'GB': {
                knownIssues: ['ISP-level content filtering'],
                supportNote: 'Check if ISP uses default DNS filtering'
            },
            'DE': {
                knownIssues: ['Strict privacy proxies'],
                supportNote: 'Check for privacy-focused browser extensions'
            },
            'AU': {
                knownIssues: ['High baseline latency'],
                supportNote: 'Latency warnings may be normal for this region'
            }
        };

        /**
         * Category → Owner mapping for failure attribution
         */
        const categoryOwnership = {
            'DNS Resolution': { owner: 'Client ISP', meaning: 'Often locally resolvable' },
            'Reachability': { owner: 'Client / Network', meaning: 'Blocks session startup' },
            'Geo Inference': { owner: 'Network', meaning: 'Routing artifact, low risk' },
            'Latency Probe': { owner: 'Network', meaning: 'May indicate congestion' },
            'Throughput': { owner: 'Network', meaning: 'Bandwidth constraint' }
        };

        /**
         * Verdict → Recommended Actions mapping
         */
        const verdictActions = {
            'environment-likely': [
                { action: 'Ask client to disable VPN or proxy', outcome: 'Reachability improves', confirms: 'Environment-related' },
                { action: 'Retry diagnostic test', outcome: 'Signals resolve', confirms: 'Transient issue' },
                { action: 'If resolved, close as environment-related', outcome: 'Ticket closed', confirms: null }
            ],
            'network-likely': [
                { action: 'Retry test off-peak hours', outcome: 'Latency improves', confirms: 'ISP congestion' },
                { action: 'Document ISP and region', outcome: 'Pattern recorded', confirms: null },
                { action: 'Escalate if persistent', outcome: 'Engineering review', confirms: 'Infrastructure issue' }
            ],
            'system-likely': [
                { action: 'Escalate with full evidence', outcome: 'Engineering triage', confirms: null },
                { action: 'Check status page for outages', outcome: 'Known issue identified', confirms: 'System outage' }
            ],
            'inconclusive': [
                { action: 'Request additional diagnostic run', outcome: 'More data collected', confirms: null },
                { action: 'Ask client about recent changes', outcome: 'Context gathered', confirms: null }
            ]
        };

        /**
         * Derive environment classification from diagnostic data
         */
        function deriveClassification(countryData) {
            const density = countryData.runCount > 0 ? countryData.signals / countryData.runCount : 0;
            const runs = countryData.runCount;

            if (runs < 5) return 'insufficient-data';
            if (density < 1) return 'stable';
            if (density <= 2) return 'noisy';
            return 'high-risk';
        }

        /**
         * Compute support verdict from aggregated statistics
         * Returns: { verdict, confidence, escalationRequired, dataSufficiency }
         */
        function computeVerdict(stats) {
            const totalRuns = stats.totalRuns;

            // Data sufficiency
            let dataSufficiency;
            if (totalRuns < 5) dataSufficiency = 'insufficient';
            else if (totalRuns <= 15) dataSufficiency = 'emerging';
            else dataSufficiency = 'stable';

            // Count failures by category
            const reachabilityFails = stats.operations['Reachability']?.fail || 0;
            const dnsFails = stats.operations['DNS Resolution']?.fail || 0;
            const geoFails = stats.operations['Geo Inference']?.fail || 0;
            const latencyFails = stats.operations['Latency Probe']?.fail || 0;

            const totalFails = Object.values(stats.operations).reduce((sum, op) => sum + op.fail, 0);
            const totalWarns = Object.values(stats.operations).reduce((sum, op) => sum + op.warn, 0);

            // Check for risk flags
            const hasPacketLoss = stats.riskFlags?.includes('PACKET_LOSS');

            // Count countries with failures
            const countriesWithFailures = Object.values(stats.countryData)
                .filter(c => c.signals > 0).length;

            let verdict = 'inconclusive';
            let confidence = 'low';
            let escalationRequired = false;

            // Decision logic
            if (totalRuns < 5) {
                verdict = 'inconclusive';
                confidence = 'low';
            } else if ((reachabilityFails + dnsFails) > totalFails * 0.6) {
                // Majority of failures are reachability/DNS → environment-likely
                verdict = 'environment-likely';
                confidence = totalRuns > 10 ? 'high' : 'medium';
                escalationRequired = false;
            } else if (hasPacketLoss || (latencyFails > 0 && geoFails > 0)) {
                // Network transit issues
                verdict = 'network-likely';
                confidence = totalRuns > 10 ? 'high' : 'medium';
                escalationRequired = false;
            } else if (countriesWithFailures >= 3 && totalFails > totalRuns * 0.5) {
                // Failures across multiple countries → system issue
                verdict = 'system-likely';
                confidence = 'high';
                escalationRequired = true;
            } else if (totalFails > 0 || totalWarns > 0) {
                // Some signals but no clear pattern
                verdict = 'inconclusive';
                confidence = 'medium';
            }

            return {
                verdict,
                confidence,
                escalationRequired,
                dataSufficiency
            };
        }

        // ==================== END SUPPORT DECISION ENGINE ====================

        /**
         * Aggregate data according to Operation Signals contract
         * - Category = operation (stable, for aggregation)
         * - Action = informational only
         * - Evidence = explanatory only
         */
        function aggregateData(runs) {
            const stats = {
                totalRuns: runs.length,
                countries: new Set(),
                runsWithSignals: 0,
                totalSignals: 0,
                operations: {},      // Category -> { pass, warn, fail }
                countryData: {},     // CountryCode -> { runs, signals, latencies, throughputs, topOp }
                latencyByCountry: {},   // CountryCode -> max latency
                throughputByCountry: {}, // CountryCode -> max throughput
                riskFlags: []        // Collected risk flags for verdict computation
            };

            for (const run of runs) {
                if (!run.Actions || !Array.isArray(run.Actions)) continue;

                let runHasSignal = false;
                let runSignalCount = 0;
                const runCountries = new Set();
                const runOperationSignals = {};

                for (const action of run.Actions) {
                    const category = action.Category || 'Unknown';
                    const result = (action.Result || '').toUpperCase();
                    const evidence = action.Evidence || {};
                    const countryCode = evidence.CountryCode || evidence.Country || null;
                    const countryName = evidence.CountryName || null;

                    // Track country
                    if (countryCode) {
                        stats.countries.add(countryCode);
                        runCountries.add(countryCode);

                        // Initialize country data
                        if (!stats.countryData[countryCode]) {
                            stats.countryData[countryCode] = {
                                name: countryName,
                                runs: new Set(),
                                signals: 0,
                                operationSignals: {}
                            };
                        }
                        stats.countryData[countryCode].runs.add(run.SessionId);
                        if (countryName) stats.countryData[countryCode].name = countryName;
                    }

                    // Track operation stats (aggregated by Category)
                    if (!stats.operations[category]) {
                        stats.operations[category] = { pass: 0, warn: 0, fail: 0 };
                    }

                    if (result === 'PASS') {
                        stats.operations[category].pass++;
                    } else if (result === 'WARN') {
                        stats.operations[category].warn++;
                        runHasSignal = true;
                        runSignalCount++;
                        if (countryCode) {
                            stats.countryData[countryCode].signals++;
                            stats.countryData[countryCode].operationSignals[category] =
                                (stats.countryData[countryCode].operationSignals[category] || 0) + 1;
                        }
                    } else if (result === 'FAIL') {
                        stats.operations[category].fail++;
                        runHasSignal = true;
                        runSignalCount++;
                        if (countryCode) {
                            stats.countryData[countryCode].signals++;
                            stats.countryData[countryCode].operationSignals[category] =
                                (stats.countryData[countryCode].operationSignals[category] || 0) + 1;
                        }
                    }

                    // Track latency/throughput extremes
                    if (countryCode && evidence.LatencyMs) {
                        const lat = parseFloat(evidence.LatencyMs);
                        if (!stats.latencyByCountry[countryCode] || lat > stats.latencyByCountry[countryCode]) {
                            stats.latencyByCountry[countryCode] = lat;
                        }
                    }
                    if (countryCode && evidence.LinkSpeedMbps) {
                        const speed = parseFloat(evidence.LinkSpeedMbps);
                        if (!stats.throughputByCountry[countryCode] || speed > stats.throughputByCountry[countryCode]) {
                            stats.throughputByCountry[countryCode] = speed;
                        }
                    }

                    // Collect risk flags for verdict computation
                    if (evidence.RiskFlags && Array.isArray(evidence.RiskFlags)) {
                        evidence.RiskFlags.forEach(flag => {
                            const flagId = flag.Id || flag;
                            if (!stats.riskFlags.includes(flagId)) {
                                stats.riskFlags.push(flagId);
                            }
                        });
                    }
                    if (evidence.PacketLossDetected && !stats.riskFlags.includes('PACKET_LOSS')) {
                        stats.riskFlags.push('PACKET_LOSS');
                    }
                    if (evidence.GeoMismatchDetected && !stats.riskFlags.includes('GEO_MISMATCH')) {
                        stats.riskFlags.push('GEO_MISMATCH');
                    }
                }

                if (runHasSignal) {
                    stats.runsWithSignals++;
                }
                stats.totalSignals += runSignalCount;
            }

            // Convert country run sets to counts
            for (const code of Object.keys(stats.countryData)) {
                stats.countryData[code].runCount = stats.countryData[code].runs.size;
            }

            return stats;
        }

        /**
         * Render all dashboard sections with aggregated data
         */
        function renderDashboard(stats) {
            // Compute verdict first
            const verdict = computeVerdict(stats);

            // Render all sections
            renderVerdictBanner(verdict, stats);
            renderActions(verdict);
            renderFailureAttribution(stats);
            renderEnvironmentCards(stats);
            renderNotablePatterns(stats);

            // Parse flag emojis with Twemoji for cross-platform consistency
            if (typeof twemoji !== 'undefined') {
                twemoji.parse(document.body, {
                    folder: 'svg',
                    ext: '.svg'
                });
            }
        }

        /**
         * Render the Support Verdict Banner
         */
        function renderVerdictBanner(verdict, stats) {
            const indicator = document.getElementById('verdict-indicator');
            const primary = document.getElementById('verdict-primary');
            const meta = document.getElementById('verdict-meta');

            // Verdict indicator emoji and text
            const verdictConfig = {
                'environment-likely': { emoji: '&#128993;', text: 'Environment-likely issue detected', class: 'environment-likely' },
                'network-likely': { emoji: '&#128992;', text: 'Network-likely issue detected', class: 'network-likely' },
                'system-likely': { emoji: '&#128308;', text: 'System-likely issue detected', class: 'system-likely' },
                'inconclusive': { emoji: '&#9898;', text: 'Inconclusive — more data needed', class: 'inconclusive' }
            };

            const config = verdictConfig[verdict.verdict] || verdictConfig['inconclusive'];

            indicator.innerHTML = config.emoji;
            primary.innerHTML = config.text;
            primary.className = `verdict-primary ${config.class}`;

            // Build metadata string
            const confidenceText = `Confidence: ${verdict.confidence.charAt(0).toUpperCase() + verdict.confidence.slice(1)}`;
            const escalationText = `Escalation: ${verdict.escalationRequired ? 'Yes' : 'No'}`;
            const sufficiencyText = `Sample: ${verdict.dataSufficiency.charAt(0).toUpperCase() + verdict.dataSufficiency.slice(1)} (${stats.totalRuns} runs)`;

            meta.textContent = `${confidenceText} · ${escalationText} · ${sufficiencyText}`;
        }

        /**
         * Render Recommended Support Actions based on verdict
         */
        function renderActions(verdict) {
            const container = document.getElementById('actions-list');
            const actions = verdictActions[verdict.verdict] || verdictActions['inconclusive'];

            container.innerHTML = actions.map((action, index) => `
                <li class="action-item">
                    <span class="action-step">${index + 1}</span>
                    <div class="action-content">
                        <div class="action-text">${action.action}</div>
                        <div class="action-outcome">Expected: ${action.outcome}</div>
                        ${action.confirms ? `<div class="action-confirms">Confirms: ${action.confirms}</div>` : ''}
                    </div>
                </li>
            `).join('');
        }

        /**
         * Render Failure Attribution Summary table
         */
        function renderFailureAttribution(stats) {
            const tbody = document.getElementById('attribution-tbody');

            // Filter to operations with signals (warn or fail)
            const operationsWithSignals = Object.entries(stats.operations)
                .filter(([_, counts]) => counts.warn > 0 || counts.fail > 0)
                .sort((a, b) => (b[1].fail + b[1].warn) - (a[1].fail + a[1].warn));

            if (operationsWithSignals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-tertiary);">No failures or warnings detected — all diagnostics passed.</td></tr>';
                return;
            }

            tbody.innerHTML = operationsWithSignals.map(([category, counts]) => {
                const total = counts.pass + counts.warn + counts.fail;

                // Determine failure pattern
                let pattern, patternClass;
                if (counts.fail > total * 0.5) {
                    pattern = 'Repeated FAIL';
                    patternClass = 'repeated';
                } else if (counts.fail > 0 && counts.fail <= total * 0.2) {
                    pattern = 'Isolated FAIL';
                    patternClass = 'isolated';
                } else if (counts.fail > 0) {
                    pattern = 'Intermittent FAIL';
                    patternClass = 'intermittent';
                } else if (counts.warn > 0) {
                    pattern = 'WARN only';
                    patternClass = 'warn-only';
                } else {
                    pattern = 'Mixed';
                    patternClass = 'isolated';
                }

                // Get ownership info
                const ownership = categoryOwnership[category] || { owner: 'Unknown', meaning: 'Requires investigation' };

                // Determine owner class for coloring
                let ownerClass = '';
                if (ownership.owner.toLowerCase().includes('client')) ownerClass = 'client';
                else if (ownership.owner.toLowerCase().includes('network')) ownerClass = 'network';
                else if (ownership.owner.toLowerCase().includes('system')) ownerClass = 'system';

                return `
                    <tr>
                        <td class="operation-name">${category}</td>
                        <td><span class="failure-pattern ${patternClass}">${pattern}</span></td>
                        <td class="owner-cell ${ownerClass}">${ownership.owner}</td>
                        <td>${ownership.meaning}</td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Render Environment Context Cards (formerly Countries Grid)
         */
        function renderEnvironmentCards(stats) {
            const grid = document.getElementById('environment-grid');
            const countries = Object.entries(stats.countryData);

            if (countries.length === 0) {
                grid.innerHTML = '<div style="padding: var(--space-lg); color: var(--text-tertiary);">No environment data available</div>';
                return;
            }

            // Sort by signal density to surface high-risk environments first
            const sortedCountries = countries.sort((a, b) => {
                const densityA = a[1].runCount > 0 ? a[1].signals / a[1].runCount : 0;
                const densityB = b[1].runCount > 0 ? b[1].signals / b[1].runCount : 0;
                return densityB - densityA;
            });

            grid.innerHTML = sortedCountries.map(([code, data]) => {
                // Derive classification from data
                const classification = deriveClassification(data);
                const classificationLabels = {
                    'stable': 'Stable',
                    'noisy': 'Moderately Noisy',
                    'high-risk': 'High Risk',
                    'insufficient-data': 'Insufficient Data'
                };

                // Get institutional knowledge if available
                const knowledge = countryKnowledge[code];
                const knownIssues = knowledge?.knownIssues?.join(', ') || 'No documented issues';
                const supportNote = knowledge?.supportNote || 'Follow standard diagnostic flow';

                return `
                    <div class="environment-card">
                        <div class="env-header">
                            <span class="country-flag">${getFlag(code)}</span>
                            <span class="country-name">${getCountryName(code, data.name)}</span>
                            <span class="env-classification ${classification}">${classificationLabels[classification]}</span>
                        </div>
                        <div class="env-known-issues">
                            <strong>Known issues:</strong> ${knownIssues}
                        </div>
                        <div class="env-support-note">
                            <strong>Support note:</strong> ${supportNote}
                        </div>
                        <div class="env-stats">
                            <span class="env-stat"><span class="env-stat-value">${data.runCount}</span> runs</span>
                            <span class="env-stat"><span class="env-stat-value">${data.signals}</span> signals</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Render Notable Patterns section (for system learning)
         */
        function renderNotablePatterns(stats) {
            const container = document.getElementById('patterns-list');
            const patterns = [];

            // Detect pattern: VPN/proxy correlation with failures
            if (stats.riskFlags.includes('VPN_DETECTED') || stats.riskFlags.includes('PROXY_DETECTED')) {
                const reachabilityFails = stats.operations['Reachability']?.fail || 0;
                if (reachabilityFails > 0) {
                    patterns.push({
                        observation: 'Reachability failures frequently co-occur with VPN/proxy usage',
                        suggestion: 'Consider adding VPN detection earlier in setup flow'
                    });
                }
            }

            // Detect pattern: Geographic clustering of failures
            const countriesWithHighDensity = Object.entries(stats.countryData)
                .filter(([_, data]) => {
                    const density = data.runCount > 0 ? data.signals / data.runCount : 0;
                    return density > 2 && data.runCount >= 3;
                });

            if (countriesWithHighDensity.length >= 2) {
                patterns.push({
                    observation: `High signal density detected in ${countriesWithHighDensity.length} regions`,
                    suggestion: 'Review regional network infrastructure or ISP patterns'
                });
            }

            // Detect pattern: Specific operation with high fail rate
            const highFailOps = Object.entries(stats.operations)
                .filter(([_, counts]) => {
                    const total = counts.pass + counts.warn + counts.fail;
                    return total > 5 && counts.fail / total > 0.4;
                });

            if (highFailOps.length > 0) {
                const opName = highFailOps[0][0];
                patterns.push({
                    observation: `${opName} diagnostic shows consistently high failure rate (>40%)`,
                    suggestion: 'Evaluate if diagnostic threshold needs adjustment or if systemic issue exists'
                });
            }

            // Detect pattern: Packet loss correlation
            if (stats.riskFlags.includes('PACKET_LOSS')) {
                const latencyFails = stats.operations['Latency Probe']?.fail || 0;
                if (latencyFails > 0) {
                    patterns.push({
                        observation: 'Packet loss detected alongside latency failures',
                        suggestion: 'May indicate network congestion — consider time-of-day analysis'
                    });
                }
            }

            // Render patterns or empty state
            if (patterns.length === 0) {
                container.innerHTML = '<div class="patterns-empty">No notable patterns detected in current data.</div>';
                return;
            }

            container.innerHTML = patterns.map(p => `
                <div class="pattern-card">
                    <div class="pattern-observation">${p.observation}</div>
                    <div class="pattern-suggestion">${p.suggestion}</div>
                </div>
            `).join('');
        }

        /**
         * Show error state - NEVER silently fall back to static data
         */
        function showError(message) {
            const banner = document.getElementById('error-banner');
            banner.textContent = `Live data unavailable: ${message}. Check data/index.json or GitHub Pages deployment.`;
            banner.style.display = 'block';

            // Set empty states for Support Decision Dashboard
            document.getElementById('verdict-indicator').innerHTML = '&#9898;';
            document.getElementById('verdict-primary').textContent = 'Data unavailable';
            document.getElementById('verdict-primary').className = 'verdict-primary inconclusive';
            document.getElementById('verdict-meta').textContent = 'Unable to compute verdict — check data source';
            document.getElementById('actions-list').innerHTML = '<li class="action-item"><span class="action-step">-</span><div class="action-content"><div class="action-text">Data unavailable</div></div></li>';
            document.getElementById('attribution-tbody').innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-tertiary);">Data unavailable</td></tr>';
            document.getElementById('environment-grid').innerHTML = '<div style="padding: var(--space-lg); color: var(--text-tertiary);">Data unavailable</div>';
            document.getElementById('patterns-list').innerHTML = '<div class="patterns-empty">Data unavailable</div>';
        }

        /**
         * Initialize dashboard on page load
         */
        async function init() {
            try {
                const runs = await loadLiveData();
                const stats = aggregateData(runs);
                renderDashboard(stats);
            } catch (err) {
                console.error('Dashboard data load failed:', err);
                showError(err.message);
            }
        }

        // Load data when DOM is ready
        document.addEventListener('DOMContentLoaded', init);

        /**
         * ==================== TAB SWITCHING ====================
         */
        function initTabs() {
            const tabs = document.querySelectorAll('.domain-tab[data-tab]');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.classList.contains('future')) return;

                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Show corresponding content
                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    const targetContent = document.getElementById(`${tabId}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }

        /**
         * ==================== BLUETOOTH TAB FUNCTIONALITY ====================
         */

        // Advanced details toggle
        function initAdvancedToggle() {
            const toggle = document.getElementById('bt-kodi-advanced-toggle');
            const content = document.getElementById('bt-kodi-advanced-content');

            if (toggle && content) {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('open');
                    content.classList.toggle('open');
                });
            }
        }

        // Copy Bluetooth Summary
        function initCopySummary() {
            const copyBtn = document.getElementById('bt-copy-summary');
            if (!copyBtn) return;

            copyBtn.addEventListener('click', async () => {
                const verdict = document.getElementById('bt-verdict-badge')?.textContent || 'UNKNOWN';
                const confidence = document.getElementById('bt-verdict-confidence')?.textContent || '';
                const summary = document.getElementById('bt-verdict-summary')?.textContent || '';

                // Collect top findings
                const findings = [];
                document.querySelectorAll('#bt-findings-list .finding-card').forEach(card => {
                    const title = card.querySelector('.finding-title')?.textContent || '';
                    const evidence = card.querySelector('.finding-evidence')?.textContent || '';
                    if (title) findings.push(`- ${title}: ${evidence}`);
                });

                // Kodi summary
                const kodiOutput = document.getElementById('bt-kodi-output')?.textContent || '';
                const kodiPassthrough = document.getElementById('bt-kodi-passthrough')?.textContent || '';
                const kodiChannels = document.getElementById('bt-kodi-channels')?.textContent || '';

                const summaryText = `Bluetooth Diagnostic Summary
=============================
Verdict: ${verdict}
${confidence}

${summary}

Top Findings:
${findings.length > 0 ? findings.join('\n') : '- No issues detected'}

Kodi Audio:
- Output: ${kodiOutput}
- Passthrough: ${kodiPassthrough}
- Channels: ${kodiChannels}

Actions Taken: None (diagnostic only)
`;

                try {
                    await navigator.clipboard.writeText(summaryText);
                    copyBtn.classList.add('copied');
                    copyBtn.innerHTML = '<span class="copy-icon">&#10003;</span> Copied!';
                    setTimeout(() => {
                        copyBtn.classList.remove('copied');
                        copyBtn.innerHTML = '<span class="copy-icon">&#128203;</span> Copy Summary';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            });
        }

        // Initialize Bluetooth tab features
        function initBluetoothTab() {
            initAdvancedToggle();
            initCopySummary();

            // Reset button handlers (placeholder - actual PowerShell integration would be needed)
            ['bt-reset-tier1', 'bt-reset-tier2', 'bt-reset-tier3'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', () => {
                        alert(`This action requires the NO Support Tool PowerShell backend.\n\nButton: ${btn.querySelector('.reset-title')?.textContent}`);
                    });
                }
            });

            // Probe state management (DIAG-EXEC-001 compliant)
            initAsyncProbe();
        }

        /**
         * Async Probe Execution (DIAG-EXEC-001)
         * - Non-blocking execution
         * - Soft-locks only conflicting actions
         * - UI remains responsive (tabs, scrolling, copy, etc.)
         */
        function initAsyncProbe() {
            const probeBtn = document.getElementById('bt-probe-btn');
            const probeStatus = document.getElementById('bt-probe-status');
            const progressBanner = document.getElementById('bt-probe-progress');
            const countdownEl = document.getElementById('bt-probe-countdown');

            // Elements to gate during probe (conflicting actions only)
            const gatedButtons = [
                document.getElementById('bt-reset-tier1'),
                document.getElementById('bt-reset-tier2'),
                document.getElementById('bt-reset-tier3')
            ].filter(Boolean);

            if (!probeBtn || !probeStatus || !progressBanner) return;

            // Probe state
            let probeState = {
                status: 'idle', // idle | running | completed | failed
                remaining: 0,
                intervalId: null,
                result: null
            };

            // Format seconds as MM:SS
            function formatTime(seconds) {
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            }

            // Gate conflicting actions
            function setGatedState(gated) {
                gatedButtons.forEach(btn => {
                    if (gated) {
                        btn.classList.add('gated');
                    } else {
                        btn.classList.remove('gated');
                    }
                });
            }

            // Update UI to reflect probe state
            function updateProbeUI() {
                if (probeState.status === 'running') {
                    // Show progress banner
                    progressBanner.style.display = 'flex';
                    countdownEl.textContent = formatTime(probeState.remaining);

                    // Update button
                    probeBtn.disabled = true;
                    probeBtn.innerHTML = `<span class="probe-spinner"></span> Probe running...`;

                    // Update status area
                    probeStatus.textContent = 'Probe in progress. Playing silent audio to test Bluetooth stability...';
                    probeStatus.style.color = 'var(--accent)';

                    // Gate conflicting actions
                    setGatedState(true);

                } else {
                    // Hide progress banner
                    progressBanner.style.display = 'none';

                    // Restore button
                    probeBtn.disabled = false;
                    probeBtn.innerHTML = '<span>&#9654;</span> Run 30s Probe';

                    // Ungate actions
                    setGatedState(false);

                    // Update status based on result
                    if (probeState.status === 'completed' && probeState.result) {
                        const r = probeState.result;
                        if (r.passed) {
                            probeStatus.innerHTML = `<span style="color: var(--signal-pass);">PASS</span> - No disconnects or device changes detected during ${r.duration}s probe.`;
                        } else {
                            probeStatus.innerHTML = `<span style="color: var(--signal-fail);">FAIL</span> - ${r.events} event(s) detected: ${r.reason}`;
                        }
                    } else if (probeState.status === 'failed') {
                        probeStatus.innerHTML = '<span style="color: var(--signal-fail);">ERROR</span> - Probe failed to execute.';
                    }
                }
            }

            // Start async probe
            function startProbe() {
                const duration = 30;
                probeState.status = 'running';
                probeState.remaining = duration;
                probeState.result = null;

                updateProbeUI();

                // Countdown timer (runs every second, UI stays responsive)
                probeState.intervalId = setInterval(() => {
                    probeState.remaining--;
                    countdownEl.textContent = formatTime(probeState.remaining);

                    if (probeState.remaining <= 0) {
                        clearInterval(probeState.intervalId);
                    }
                }, 1000);

                // Simulate async probe execution
                // In real implementation: PowerShell background job / runspace
                runProbeAsync(duration).then(result => {
                    clearInterval(probeState.intervalId);
                    probeState.status = 'completed';
                    probeState.result = result;
                    updateProbeUI();
                }).catch(err => {
                    clearInterval(probeState.intervalId);
                    probeState.status = 'failed';
                    probeState.result = { error: err.message };
                    updateProbeUI();
                });
            }

            // Simulated async probe (replace with actual PowerShell integration)
            function runProbeAsync(duration) {
                return new Promise((resolve) => {
                    // Simulate background execution
                    setTimeout(() => {
                        // Simulate random result for demo
                        const passed = Math.random() > 0.2;
                        resolve({
                            passed,
                            duration,
                            events: passed ? 0 : Math.floor(Math.random() * 3) + 1,
                            reason: passed ? null : 'Device re-enumeration detected'
                        });
                    }, duration * 1000);
                });
            }

            // Attach click handler
            probeBtn.addEventListener('click', () => {
                if (probeState.status !== 'running') {
                    startProbe();
                }
            });
        }

        // Initialize all tab functionality
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            initBluetoothTab();
        });
    </script>
</body>
</html>
